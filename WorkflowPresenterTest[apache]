package org.apache.taverna.mobile.ui.workflow;

import org.apache.taverna.mobile.FakeRemoteDataSource;
import org.apache.taverna.mobile.R;
import org.apache.taverna.mobile.data.DataManager;
import org.apache.taverna.mobile.data.model.Workflows;
import org.apache.taverna.mobile.utils.RxSchedulersOverrideRule;
import org.junit.After;
import org.junit.Before;
import org.junit.Rule;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;

import java.util.HashMap;
import java.util.Map;

import io.reactivex.Observable;

import static org.mockito.Mockito.never;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

@RunWith(MockitoJUnitRunner.class)
public class WorkflowPresenterTest {

    @Rule
    public final RxSchedulersOverrideRule rxSchedulersOverrideRule = new
            RxSchedulersOverrideRule();
    @Mock
    DataManager dataManager;

    @Mock
    WorkflowMvpView workflowMvpView;

    private Workflows workflows;
    private WorkflowPresenter workflowPresenter;
    private Map<String, String> wokflow_option;
    private Map<String, String> search_option;
    private String query = "demo-02";

    @Before
    public void setUp(){

        workflowPresenter = new WorkflowPresenter(dataManager);
        workflowPresenter.attachView(workflowMvpView);

        workflows = FakeRemoteDataSource.getWorkflowList();

        wokflow_option = new HashMap<>();
        wokflow_option.put("elements", "title,type,uploader,preview,created-at");
        wokflow_option.put("page", String.valueOf(1));
        wokflow_option.put("num", String.valueOf(10));
        wokflow_option.put("order", "reverse");

        search_option = new HashMap<>();
        search_option.put("query", query);
        search_option.put("type", "workflow");

    }

    @After
    public void tearDown(){

        workflowPresenter.detachView();
    }

    @Test
    public void loadAllWorkflow_validWorkflowList_ReturnsResults() {

        when(dataManager.getAllWorkflow(wokflow_option)).thenReturn(
                Observable.just(workflows));


        workflowPresenter.loadAllWorkflow(1);

        verify(workflowMvpView).showProgressbar(true);
        verify(workflowMvpView).removeLoadMoreProgressbar();
        verify(workflowMvpView).showWorkflows(workflows);
        verify(workflowMvpView, never()).showSnackBar(R.string.error_failed_to_fetch_workflow);

    }

    @Test
    public void loadAllWorkflow_RuntimeError_showError(){

        when(dataManager.getAllWorkflow(wokflow_option)).thenReturn(
                Observable.<Workflows>error(new RuntimeException()));

        workflowPresenter.loadAllWorkflow(1);

        verify(workflowMvpView).showProgressbar(false);
        verify(workflowMvpView).removeLoadMoreProgressbar();
        verify(workflowMvpView, never()).showWorkflows(workflows);
        verify(workflowMvpView).showSnackBar(R.string.error_failed_to_fetch_workflow);

    }
    

}
